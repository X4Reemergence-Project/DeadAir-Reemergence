<?xml version="1.0" encoding="iso-8859-1" ?>
<mdscript name="DASYWUsage" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
	<cues>
		<cue name="Init">
			<actions>
				<set_value name="md.$DAShipyardWharfTable" exact="table[]"/>
				<set_value name="$LastPrintTriggerTime" exact="0"/>
				<set_value name="$OutputDebugText" exact="false"/>
				<create_group groupname="md.$DAShipyardWharfGroup"/>
				<!-- 
				md.$DAShipyardWharfTable.{$Station}.$InitialDataTime == time of intial data
				md.$DAShipyardWharfTable.{$Station}.{$Ware}.$StartAmount == Starting Amount
				md.$DAShipyardWharfTable.{$Station}.{$Ware}.$TradeAmount == Buy is positive, Sell is negative
				(Current - $TradeAmount - $StartAmount) / ((player.age - $InitialDataTime) / 3600.0)
				md.$DAShipyardWharfGroup == group with stations
				-->
			</actions>
			<cues>
				<cue name="InitialCheck" instantiate="false">
					<conditions>
						<check_any>
							<event_cue_completed cue="md.Setup.Start"/>
							<event_universe_generated/>
							<event_game_loaded/>
						</check_any>
					</conditions>
					<actions>
						<find_station groupname="$Stations" multiple="true" space="player.galaxy" functional="true" append="true">
							<match_any>
								<match shipyard="true"/>
								<match wharf="true"/>
							</match_any>
						</find_station>
						<do_for_each name="$Station" in="$Stations">
							<set_value name="$NewStation" exact="false"/>
							<do_if value="not md.$DAShipyardWharfTable.{$Station}?">
								<set_value name="md.$DAShipyardWharfTable.{$Station}" exact="table[]"/>
								<set_value name="md.$DAShipyardWharfTable.{$Station}.$InitialDataTime" exact="player.age"/>
								<set_value name="$NewStation" exact="true"/>
								<debug_to_file name="$Station.idcode" directory="'DADebug'" text="'%s(%s) in %s -- Starting Log File at %s'.[$Station.knownname,$Station.idcode,$Station.sector.knownname,player.age]" output="false" append="false"/>
							</do_if>
							<do_if value="not md.$DAShipyardWharfGroup.indexof.{$Station}">
								<add_to_group groupname="md.$DAShipyardWharfGroup" object="$Station"/>
								<set_value name="$NewStation" exact="true"/>
								<debug_to_file name="$Station.idcode" directory="'DADebug'" text="'Signalled Watcher at %s'.[player.age]" output="false" append="true"/>
							</do_if>
							<do_for_each name="$Ware" in="$Station.resources.list">
								<do_if value="not md.$DAShipyardWharfTable.{$Station}.{$Ware}?">
									<set_value name="md.$DAShipyardWharfTable.{$Station}.{$Ware}" exact="table[]"/>
									<set_value name="md.$DAShipyardWharfTable.{$Station}.{$Ware}.$StartAmount" exact="$Station.cargo.{$Ware}.count"/>
									<set_value name="md.$DAShipyardWharfTable.{$Station}.{$Ware}.$TradeAmount" exact="0L"/>
								</do_if>
							</do_for_each>
							<do_if value="$NewStation">
								<signal_cue_instantly cue="DASYWWatcher" param="$Station"/>
							</do_if>
							<remove_value name="$NewStation"/>
						</do_for_each>
						<remove_value name="$Stations"/>
						<debug_text text="'MOD: DADebug -- Statistics Monitoring -- Keys.count: %s -- Group.count: %s.'.[md.$DAShipyardWharfTable.keys.list.count,md.$DAShipyardWharfGroup.count]" context="false" filter="scripts"/>
						<reset_cue cue="this"/>
					</actions>
				</cue>
				<cue name="DASYWPrintTimer" instantiate="true" checkinterval="30min" checktime="30min">
					<actions>
						<set_value name="$OutputDebugText" exact="false"/>
						<signal_cue_instantly cue="DASYWPrint"/>
					</actions>
				</cue>
				<cue name="DASYWPrintTrigger" instantiate="true">
					<conditions>
						<event_long_range_scan_sent object="player.entity"/>
						<check_value value="@player.occupiedship.activeweapongroup.primary == 3"/>
						<check_value value="player.age ge ($LastPrintTriggerTime + 5s)"/>
					</conditions>
					<actions>
						<set_value name="$LastPrintTriggerTime" exact="player.age"/>
						<set_value name="$OutputDebugText" exact="true"/>
						<signal_cue_instantly cue="DASYWPrint"/>
					</actions>
				</cue>
				<cue name="DASYWPrint" instantiate="false">
					<conditions>
						<event_cue_signalled/>
					</conditions>
					<actions>
						<debug_text text="'MOD: DADebug -- Statistics Monitoring -- Starting Output'" context="false" filter="scripts"/>
						<set_value name="$StationList" exact="md.$DAShipyardWharfTable.keys.list"/>
						<do_for_each name="$Station" in="$StationList">
							<do_if value="md.$DAShipyardWharfGroup.indexof.{$Station}">
								<set_value name="$KeyList" exact="md.$DAShipyardWharfTable.{$Station}.keys.list"/>
								<remove_from_list name="$KeyList" exact="'$InitialDataTime'"/>
								<set_value name="$HeaderString" exact="'%s(%s)(%s) -- %s -- Ware Report\nWare,Change Per Hour,Total Change,Current Amount,Traded Amount,Starting Amount,Total Time,Current Time,Inital Time'.[$Station.knownname,$Station.idcode,$Station.sector.knownname,player.age]"/>
								<debug_to_file name="$Station.idcode" directory="'DADebug'" text="$HeaderString" output="false" append="true"/>
								<do_if value="$OutputDebugText">
									<debug_text text="$HeaderString" context="false" filter="scripts"/>
								</do_if>
								<do_for_each name="$Ware" in="$KeyList">
									<do_if value="md.$DAShipyardWharfTable.{$Station}.{$Ware}.$StartAmount? and md.$DAShipyardWharfTable.{$Station}.{$Ware}.$TradeAmount?">
										<set_value name="$CurrentAmount" exact="$Station.cargo.{$Ware}.count"/>
										<set_value name="$TradedAmount" exact="md.$DAShipyardWharfTable.{$Station}.{$Ware}.$TradeAmount"/>
										<set_value name="$StartingAmount" exact="md.$DAShipyardWharfTable.{$Station}.{$Ware}.$StartAmount"/>
										<set_value name="$TotalChange" exact="$CurrentAmount - $TradedAmount - $StartingAmount"/>
										<set_value name="$CurrentTime" exact="player.age" comment="in seconds"/>
										<set_value name="$InitialTime" exact="md.$DAShipyardWharfTable.{$Station}.$InitialDataTime" comment="in seconds"/>
										<set_value name="$TotalTime" exact="$CurrentTime - $InitialTime" comment="in seconds"/>
										<set_value name="$ChangePerHour" exact="$TotalChange / ($TotalTime / 3600.0)"/>
										<!-- $Ware,$ChangePerHour,$TotalChange,$CurrentAmount,$TradedAmount,$StartingAmount,$TotalTime,$CurrentTime,$InitialTime -->
										<set_value name="$WareString" exact="'%s,%s,%s,%s,%s,%s,%s,%s,%s'.[$Ware,$ChangePerHour,$TotalChange,$CurrentAmount,$TradedAmount,$StartingAmount,$TotalTime,$CurrentTime,$InitialTime]"/>
										<debug_to_file name="$Station.idcode" directory="'DADebug'" text="$WareString" output="false" append="true"/>
										<do_if value="$OutputDebugText">
											<debug_text text="$WareString" context="false" filter="scripts"/>
										</do_if>
										<remove_value name="$CurrentAmount"/>
										<remove_value name="$TradedAmount"/>
										<remove_value name="$StartingAmount"/>
										<remove_value name="$TotalChange"/>
										<remove_value name="$CurrentTime"/>
										<remove_value name="$InitialTime"/>
										<remove_value name="$TotalTime"/>
										<remove_value name="$ChangePerHour"/>
										<remove_value name="$WareString"/>
									</do_if>
								</do_for_each>
								<remove_value name="$KeyList"/>
								<remove_value name="$HeaderString"/>
							</do_if>
							<do_else>
								<remove_value name="md.$DAShipyardWharfTable.{$Station}"/>
							</do_else>
						</do_for_each>
						<remove_value name="$StationList"/>
						<debug_text text="'MOD: DADebug -- Statistics Monitoring -- Completed Output'" context="false" filter="scripts"/>
						<reset_cue cue="this"/>
					</actions>
				</cue>
			</cues>
		</cue>
		<cue name="DASYWWatcher" instantiate="true" namespace="this">
			<conditions>
				<event_cue_signalled/>
			</conditions>
			<actions>
				<set_value name="$WatchStation" exact="event.param"/>
				<set_value name="$WatchStationIDCode" exact="$WatchStation.idcode"/>
				<debug_to_file name="$WatchStationIDCode" directory="'DADebug'" text="'Watcher started at %s'.[player.age]" output="false" append="true"/>
			</actions>
			<cues>
				<cue name="DASYStatGather" instantiate="true">
					<conditions>
						<event_trade_completed buyer="$WatchStation"/>
					</conditions>
					<actions>
						<do_if value="md.$DAShipyardWharfTable.{$WatchStation}?">
							<set_value name="$Buyer" exact="event.param.buyer"/>
							<set_value name="$Trade" exact="event.param"/>
							<set_value name="$Ware" exact="$Trade.ware"/>
							<set_value name="$Amount" exact="$Trade.transferredamount"/>
							<do_if value="md.$DAShipyardWharfTable.{$Buyer}.{$Ware}.$StartAmount? and md.$DAShipyardWharfTable.{$Buyer}.{$Ware}.$TradeAmount?">
								<set_value name="md.$DAShipyardWharfTable.{$Buyer}.{$Ware}.$TradeAmount" exact="$Amount" operation="add"/>
							</do_if>
							<do_elseif value="not md.$DAShipyardWharfTable.{$Buyer}.{$Ware}?">
								<set_value name="md.$DAShipyardWharfTable.{$Buyer}.{$Ware}" exact="table[]"/>
								<set_value name="md.$DAShipyardWharfTable.{$Buyer}.{$Ware}.$StartAmount" exact="$Buyer.cargo.{$Ware}.count"/>
								<set_value name="md.$DAShipyardWharfTable.{$Buyer}.{$Ware}.$TradeAmount" exact="0L"/>
							</do_elseif>
							<do_elseif value="(not md.$DAShipyardWharfTable.{$Buyer}.{$Ware}.$StartAmount?) or (not md.$DAShipyardWharfTable.{$Buyer}.{$Ware}.$TradeAmount?)">
								<do_if value="not md.$DAShipyardWharfTable.{$Buyer}.{$Ware}.$StartAmount?">
									<set_value name="md.$DAShipyardWharfTable.{$Buyer}.{$Ware}.$StartAmount" exact="$Buyer.cargo.{$Ware}.count"/>
								</do_if>
								<do_if value="not md.$DAShipyardWharfTable.{$Buyer}.{$Ware}.$TradeAmount?">
									<set_value name="md.$DAShipyardWharfTable.{$Buyer}.{$Ware}.$TradeAmount" exact="0L"/>
								</do_if>
							</do_elseif>
						</do_if>
						<do_else>
							<debug_text text="'MOD: DADebug -- %s -- Cancelling watcher for %s(%s)(%s)'.[player.age,$WatchStation.knownname,$WatchStation.idcode,$WatchStation.sector.knownname]" context="false" filter="scripts"/>
							<debug_to_file name="$WatchStationIDCode" directory="'DADebug'" text="'Watcher Ended at %s due to missing table entry'.[player.age]" output="false" append="true"/>
							<remove_value name="md.$DAShipyardWharfTable.{$WatchStation}"/>
							<remove_from_group group="md.$DAShipyardWharfGroup" object="$WatchStation"/>
							<cancel_cue cue="DASYWWatcher"/>
						</do_else>
					</actions>
				</cue>
				<cue name="DASYWRemoveDead" instantiate="true">
					<conditions>
						<event_object_destroyed object="$WatchStation"/>
					</conditions>
					<actions>
						<remove_value name="md.$DAShipyardWharfTable.{$WatchStation}"/>
						<do_if value="md.$DAShipyardWharfGroup.indexof.{$WatchStation}">
							<remove_from_group group="md.$DAShipyardWharfGroup" object="$WatchStation"/>
						</do_if>
						<debug_to_file name="$WatchStationIDCode" directory="'DADebug'" text="'Watcher Ended at %s due to station destruction'.[player.age]" output="false" append="true"/>
						<cancel_cue cue="DASYWWatcher"/>
					</actions>
				</cue>
			</cues>
		</cue>
	</cues>
</mdscript>
